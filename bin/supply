#!/bin/sh
set -e

if [[ -z "${SIGNALFX_ACCESS_TOKEN}" ]]; then
  echo "SIGNALFX_ACCESS_TOKEN env var not set"
  exit 0
else
  echo "found SIGNALFX_ACCESS_TOKEN, continuing with staging"
fi

echo "curr dir: $(pwd)"
echo "contents: $(ls)"
echo "vars"

bin_dir=$(cd $(dirname $0); pwd) # absolute path
root_dir=$(dirname $bin_dir)


echo $root_dir
ls -al $root_dir





mkdir -p $3/$4/.profile.d
cp $root_dir/run-collectd.sh $3/$4/.profile.d
chmod +x $3/$4/.profile.d/run-collectd.sh

if [ -z ${SIGFX_TGZ_URI+x} ]
then
  SIGFX_TGZ_URI=https://github.com/signalfx/collectd-build-bundle/releases/download/v5.7.2-sfx0-1/collectd-bundle-5.7.2-sfx0-1.tar.gz
fi


wget $SIGFX_TGZ_URI --quiet -O $3/$4/sigfx.tgz
cd $3/$4
tar xfz $3/$4/sigfx.tgz




cat <<EOF >> $3/$4/config.yml
---
name: signalfx-multi-buildpack
config:
  java_opts:
    preformatted_options: ["-Dscript_2=\$(\$HOME/../deps/$4/.profile.d/run-collectd.sh)"]
EOF



